<header>
  <div class="navbar-fixed">
    <nav id="navbarHeader">
      <div class="hide" id="hiddenSearchMobile">
        <form action="/" style="z-index: 90; width: 100%; top: 0; left: 0;" class="brand-logo">
          <input id="headerSearchMobile" type="text" name="search" placeholder="Search...">
        </form>
        <div id="headerSearchResultsMobile" class="card card-stacked card-content searchResultsMobile flow-text">
        </div>
      </div>
      <div class="nav-wrapper container">
        <div class="brand-logo" id="logo" style="height: 100%; display: inline-block; position: relative;">
          <a href="/index.html">
            <img style="height: 100%;" class="left" src="/static/images/ic_web.png" />
            <h4 class="right" id="logotitle" style="margin-left: 5px;"><b><span style="color: #ff9800;">xda</span>labs</b></h4>
          </a>
        </div>
        <form action="/" style="margin-right: 80px; margin-top: -5px;" class="hide-on-med-and-down brand-logo right">
          <input id="headerSearch" autocomplete="off" type="text" name="search" placeholder="Search...">
            <div id="headerSearchResults" class="card card-stacked card-content searchResults flow-text">
            </div>
        </form>

        <div id="searchIconCont" class="brand-logo right hide-on-large-only" style="right: 40px;"><i id="searchIcon" class="medium material-icons" style="font-size: 2rem">search</i></div>

        {% with logout_url="/store/logout/" login_text="Login" logout_text="Logout" %}

        <div class="brand-logo right hide-on-large-only">
            <a href="{% if logged_in %}{{ logout_url }}{% else %}{{ xda_authorize_url }}{% endif %}">
                <i class="medium material-icons" style="font-size: 2rem; margin-left: auto; margin-right: 0">account_circle</i>
            </a>
        </div>

        <a href="{% if logged_in %}{{ logout_url }}{% else %}{{ xda_authorize_url }}{% endif %}">
            <h6 class="hide-on-med-and-down right brand-logo" style="font-size: 1.6rem; margin-top: 20px; color: #ffffff;">{% if logged_in %}{{ logout_text }}{% else %}{{ login_text }}{% endif %}</h6>
        </a>

      {% endwith %}

      </div>
    </nav>
  </div>

</header>
<script>
    window.onload = function() {
        let mobileInput = $("#headerSearchMobile");
        let desktopInput = $("#headerSearch");
        let desktopSearchResults = $("#headerSearchResults");
        let mobileSearchResults = $("#headerSearchResultsMobile");

        $.ajaxSetup({ cache: true });

        $("#searchIconCont").on('click', function () {
            $("#hiddenSearchMobile").removeClass("hide");
            mobileInput.focus();
        });

        mobileInput.keyup(function(k) {
            if (k.which === 27) {  // ESC
                clearAndCloseMobileSearch();
            } else {
                clearTimeout(timeoutID);
                timeoutID = setTimeout(() => searchApp($(this).val()), 400);
            }
        });
        mobileInput.blur(function() {
            setTimeout(() => clearAndCloseMobileSearch(), 100);
        });

        function clearAndCloseMobileSearch() {
            $("#hiddenSearchMobile").addClass("hide");
            hideMobileResults();
        }

        function hideDesktopResults() {
            if (desktopSearchResults.hasClass("searchResultsExpanded")) {
                desktopSearchResults.removeClass("searchResultsExpanded");
            }
        }

        function hideMobileResults() {
            if (mobileSearchResults.hasClass("searchResultsExpanded")) {
                mobileSearchResults.removeClass("searchResultsExpanded");
            }
        }

        desktopInput.blur(function() {
            hideDesktopResults();
        });

        desktopInput.on('webkitTransitionEnd otransitionend msTransitionEnd transitionend', function() {
            let searchVal = desktopInput.val();
            if (desktopInput.is(":focus")) {
                if (searchVal !== null) {
                    searchApp(searchVal);
                }
            } else {
                hideDesktopResults();
            }
        });

        let timeoutID = null;

        function searchApp(str) {
            if (str !== null && str.length > 2) {
                $.getJSON("/api/1/search?q=" + str, function (r) {
                    parseSearchResults(r.results);
                });
            }
        }

        function parseSearchResults(rArray) {
            console.log(rArray);
            let isMobile = $("#searchIconCont").css('display') !== "none";

            let searchResults;

            if (isMobile) {
                searchResults = mobileSearchResults;
            } else {
                searchResults = desktopSearchResults;
            }
            searchResults.empty();

            $.each(rArray, function (i, result) {
                searchResults.append('<div class="row searchResultsRow" onclick="launchSearch(\'' + result.package_name + '\')"><span>' + result.title + '</span><div class="searchStar"><span class="orange-text">&#x2605;</span>' + result.avg_rating.toFixed(1) + '</div></a></div>');
            });

            searchResults.delay(100).addClass("searchResultsExpanded");
        }

        desktopInput.keyup(function() {
            clearTimeout(timeoutID);
            timeoutID = setTimeout(() => searchApp($(this).val()), 250);
        });

    };

    function launchSearch(s) {
        window.location.href = "/store/app/" + s;
    }

</script>
